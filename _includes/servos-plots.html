<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<div class="project-section-clean">
    <h3>Data Visualization</h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Cartesian Path Plot -->
        <div id="cartesian-plot"
            style="height: 400px; background: var(--surface-color); border-radius: var(--radius-lg); border: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div class="plot-status" style="color: var(--text-secondary);">Waiting for data...</div>
        </div>

        <!-- Joint Dynamics Plot -->
        <div id="joint-plot"
            style="height: 400px; background: var(--surface-color); border-radius: var(--radius-lg); border: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div class="plot-status" style="color: var(--text-secondary);">Waiting for data...</div>
        </div>
    </div>

    <script>
        (function () {
            async function initServosPlots() {
                // Polling wait for Plotly (timeout 10s)
                if (typeof Plotly === 'undefined') {
                    const maxWait = 10000;
                    const interval = 100;
                    let elapsed = 0;
                    // Optional: visible status
                    document.querySelectorAll('.plot-status').forEach(el => el.innerText = "Loading Plotly library...");

                    while (typeof Plotly === 'undefined' && elapsed < maxWait) {
                        await new Promise(r => setTimeout(r, interval));
                        elapsed += interval;
                    }

                    if (typeof Plotly === 'undefined') {
                        console.error("ServosPlots: Plotly not found (Timeout).");
                        document.querySelectorAll('.plot-status').forEach(el => el.innerText = "Error: Plotly failed to load (Timeout).");
                        return;
                    }
                }

                const commonLayout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() },
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { l: 50, r: 20, b: 50, t: 30 },
                    xaxis: {
                        gridcolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        zerolinecolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                    },
                    yaxis: {
                        gridcolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        zerolinecolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                    }
                };

                // ---- Plot 1: Cartesian Path ----
                try {
                    const el = document.getElementById('cartesian-plot');
                    if (el) el.querySelector('.plot-status').innerText = "Fetching Path Data...";

                    // Note: Jekyll includes are processed on server side, so string concatenation is safe here
                    const response = await fetch("{{ '/assets/data/servos/robot_cartesian_path.csv' | relative_url }}");
                    if (!response.ok) throw new Error("File not found (Path): " + response.status);

                    const text = await response.text();
                    const rows = text.trim().split(/\r?\n/);
                    const x = [], y = [];

                    // Skip header
                    for (let i = 1; i < rows.length; i++) {
                        const parts = rows[i].split(',');
                        if (parts.length >= 2) {
                            const valX = parseFloat(parts[0]);
                            const valY = parseFloat(parts[1]);
                            if (!isNaN(valX) && !isNaN(valY)) {
                                x.push(valX);
                                y.push(valY);
                            }
                        }
                    }

                    if (x.length > 0) {
                        // Clear status message
                        if (el) el.innerHTML = '';
                        Plotly.newPlot('cartesian-plot', [{
                            x: x, y: y, mode: 'lines', name: 'End Effector Path',
                            line: { color: '#3b82f6', width: 2 }
                        }], {
                            ...commonLayout,
                            title: 'Cartesian Path (X vs Y)',
                            xaxis: { ...commonLayout.xaxis, title: 'X Position (m)' },
                            yaxis: { ...commonLayout.yaxis, title: 'Y Position (m)', scaleanchor: "x" }
                        }, { responsive: true, displayModeBar: false });
                    } else {
                        if (el && el.querySelector('.plot-status')) el.querySelector('.plot-status').innerText = "Empty/Invalid X-Y Data.";
                    }
                } catch (e) {
                    console.error('Servos Cartesian Error:', e);
                    const el = document.getElementById('cartesian-plot');
                    if (el) el.innerHTML = `<div class='plot-status' style='color: #ef4444;'>Error loading Path: ${e.message}</div>`;
                }

                // ---- Plot 2: Joint Dynamics ----
                try {
                    const el = document.getElementById('joint-plot');
                    if (el) el.querySelector('.plot-status').innerText = "Fetching Joint Data...";

                    const response = await fetch("{{ '/assets/data/servos/robot_joint_dynamics.csv' | relative_url }}");
                    if (!response.ok) throw new Error("File not found (Joints): " + response.status);

                    const text = await response.text();
                    const rows = text.trim().split(/\r?\n/);
                    const t = [], th1 = [], th2 = [];

                    for (let i = 1; i < rows.length; i++) {
                        const parts = rows[i].split(',');
                        if (parts.length >= 3) {
                            const valT = parseFloat(parts[0]);
                            const valTh1 = parseFloat(parts[1]);
                            const valTh2 = parseFloat(parts[2]);
                            if (!isNaN(valT)) {
                                t.push(valT);
                                th1.push(valTh1);
                                th2.push(valTh2);
                            }
                        }
                    }

                    if (t.length > 0) {
                        if (el) el.innerHTML = '';
                        Plotly.newPlot('joint-plot', [
                            { x: t, y: th1, mode: 'lines', name: 'Theta 1', line: { color: '#10b981' } },
                            { x: t, y: th2, mode: 'lines', name: 'Theta 2', line: { color: '#ef4444' } }
                        ], {
                            ...commonLayout,
                            title: 'Joint Angles Over Time',
                            xaxis: { ...commonLayout.xaxis, title: 'Time (s)' },
                            yaxis: { ...commonLayout.yaxis, title: 'Angle (rad)' }
                        }, { responsive: true, displayModeBar: false });
                    } else {
                        if (el && el.querySelector('.plot-status')) el.querySelector('.plot-status').innerText = "Empty/Invalid Joint Data.";
                    }
                } catch (e) {
                    console.error('Servos Joint Error:', e);
                    const el = document.getElementById('joint-plot');
                    if (el) el.innerHTML = `<div class='plot-status' style='color: #ef4444;'>Error loading Joints: ${e.message}</div>`;
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initServosPlots);
            } else {
                initServosPlots();
            }
        })();
    </script>
</div>
