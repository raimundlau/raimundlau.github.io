<!-- Universal Plot Handler - Robust CSV visualization using Plotly -->
<div id="universal-plots-container" style="width: 100%; padding: 0; margin: 20px 0;">
    <h3 style="font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: var(--spacing-sm); margin: 0 0 var(--spacing-md) 0;">{{ page.plots_title | default: "Data Visualization" }}</h3>
    <div id="plots-grid" style="width: 100%; margin: 0; padding: 0;"></div>
    
    <!-- Store site baseurl for use in JavaScript -->
    <script>
        window.SITE_BASEURL = "{{ site.baseurl }}";
    </script>
    
    <script>
        window.universalPlotData = {};
        
        // Parse CSV with column headers
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/).filter(l => l.trim());
            if (lines.length < 2) return { headers: [], rows: [] };

            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => {
                    const num = parseFloat(v.trim());
                    return isNaN(num) ? null : num;
                });
                rows.push(values);
            }
            return { headers, rows };
        }
        
        // Get column data
        function getColumn(data, columnIndex) {
            return data.rows.map(row => row[columnIndex]).filter(v => v !== null);
        }
        
        // Add baseurl to path if needed
        function resolvePath(path) {
            if (window.SITE_BASEURL && !path.startsWith(window.SITE_BASEURL)) {
                return window.SITE_BASEURL + path;
            }
            return path;
        }
        
        // Build plot config from Jekyll
        {% if page.plots %}
        const plotConfigs = [
            {% for plot in page.plots %}
            {
                id: "plot-{{ forloop.index0 }}",
                title: "{{ plot.title }}",
                xFile: "{{ plot.x_file }}",
                xColumn: {{ plot.x_column | default: 0 }},
                yFiles: [
                    {% for yfile in plot.y_files %}
                    {
                        file: "{{ yfile.file }}",
                        column: {{ yfile.column }},
                        label: "{{ yfile.label }}"
                    }
                    {% unless forloop.last %},{% endunless %}
                    {% endfor %}
                ],
                xLabel: "{{ plot.x_label }}",
                yLabel: "{{ plot.y_label }}"
            }
            {% unless forloop.last %},{% endunless %}
            {% endfor %}
        ];
        {% else %}
        const plotConfigs = [];
        {% endif %}
        
        const colors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899'];
        let colorIdx = 0;
        function getColor() { return colors[colorIdx++ % colors.length]; }
        function resetColors() { colorIdx = 0; }
        
        // Load all plots
        async function initPlots() {
            console.log('[Plot Handler] Initializing plots...');
            console.log('[Plot Handler] SITE_BASEURL:', window.SITE_BASEURL);
            console.log('[Plot Handler] Number of plots:', plotConfigs.length);

            if (!plotConfigs || plotConfigs.length === 0) {
                document.getElementById('universal-plots-container').innerHTML = '<p style="color: #666;">No plots configured</p>';
                return;
            }

            if (typeof Plotly === 'undefined') {
                document.getElementById('universal-plots-container').innerHTML = '<p style="color: red;">Plotly not loaded</p>';
                return;
            }

            const grid = document.getElementById('plots-grid');
            for (let i = 0; i < plotConfigs.length; i++) {
                const config = plotConfigs[i];
                console.log(`[Plot Handler] Loading plot ${i}:`, config.title);
                resetColors();  // Reset colors for each plot
                const container = document.createElement('div');
                container.id = config.id;
                container.style.cssText = 'width: 100%; height: 400px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--surface-color);';
                grid.appendChild(container);

                try {
                    await renderPlot(config, container);
                } catch (err) {
                    console.error(`[Plot Handler] Error on plot ${i}:`, err);
                    container.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + err.message + '</div>';
                }
            }
        }
        
        async function renderPlot(config, container) {
            try {
                console.log(`[renderPlot] Starting for ${config.title}`);
                console.log(`[renderPlot] X file: ${config.xFile}`);

                // Fetch X data - use resolvePath to add baseurl if needed
                let xRes, xData = [];
                try {
                    const xUrl = resolvePath(config.xFile);
                    console.log(`[renderPlot] Resolved X URL: ${xUrl}`);
                    xRes = await fetch(xUrl);
                    if (!xRes.ok) {
                        throw new Error(`HTTP ${xRes.status}`);
                    }
                    const xText = await xRes.text();
                    console.log(`[renderPlot] X data loaded, length: ${xText.length}`);
                    xData = getColumn(parseCSV(xText), config.xColumn);
                    console.log(`[renderPlot] X data parsed, ${xData.length} values`);
                } catch (err) {
                    throw new Error(`Cannot load X: ${config.xFile} - ${err.message}`);
                }

                if (xData.length === 0) throw new Error('X data is empty');

                // Fetch Y data
                const traces = [];
                for (const yFile of config.yFiles) {
                    try {
                        const yUrl = resolvePath(yFile.file);
                        console.log(`[renderPlot] Resolved Y URL: ${yUrl}`);
                        const yRes = await fetch(yUrl);
                        if (!yRes.ok) {
                            throw new Error(`HTTP ${yRes.status}`);
                        }
                        const yText = await yRes.text();
                        console.log(`[renderPlot] Y data loaded, length: ${yText.length}`);
                        const yData = getColumn(parseCSV(yText), yFile.column);
                        console.log(`[renderPlot] Y data parsed, ${yData.length} values for ${yFile.label}`);

                        if (yData.length > 0) {
                            const len = Math.min(xData.length, yData.length);
                            traces.push({
                                x: xData.slice(0, len),
                                y: yData.slice(0, len),
                                mode: 'lines',
                                name: yFile.label,
                                line: { color: getColor(), width: 2 }
                            });
                        }
                    } catch (err) {
                        console.warn(`Could not load ${yFile.file}: ${err.message}`);
                    }
                }

                if (traces.length === 0) throw new Error('No Y data could be loaded');

                console.log(`[renderPlot] Creating plot with ${traces.length} traces`);
                const layout = {
                    title: config.title,
                    xaxis: { title: config.xLabel },
                    yaxis: { title: config.yLabel },
                    showlegend: traces.length > 1,
                    responsive: true,
                    margin: { l: 60, r: 20, t: 40, b: 60 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: 'inherit' }
                };

                Plotly.newPlot(config.id, traces, layout, { responsive: true, displayModeBar: true });
                console.log(`[renderPlot] Plot ${config.id} rendered successfully`);
            } catch (err) {
                container.innerHTML = '<div style="padding: 20px; color: red; line-height: 1.6;"><strong>Plot Error:</strong><br/>' + err.message + '</div>';
                console.error('[renderPlot] Error:', err);
            }
        }
        
        // Start when Plotly is ready
        function checkPlotly() {
            if (typeof Plotly !== 'undefined') {
                initPlots();
            } else {
                setTimeout(checkPlotly, 100);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkPlotly);
        } else {
            checkPlotly();
        }
    </script>
</div>
